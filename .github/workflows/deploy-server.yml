name: Deploy Server (Backend)

on:
  push:
    branches:
      - main # main 브랜치에 push될 때 실행
    paths:
      - 'packages/server/**' # server 패키지 변경 시에만 실행
  workflow_dispatch: # 수동 실행 가능

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.11.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build server package
        run: pnpm build:server
        env:
          NODE_ENV: production

      - name: Deploy dist to server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: 'packages/server/dist/*'
          target: ${{ secrets.SERVER_DEPLOY_PATH }}
          strip_components: 3 # packages/server/dist 경로 제거
          rm: true # 기존 파일 삭제 후 업로드

      - name: Deploy additional files (ecosystem.config.js, package.json)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: 'ecosystem.config.js'
          target: ${{ secrets.SERVER_DEPLOY_PATH }}
          overwrite: true

      - name: Deploy additional files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: 'packages/server/package.json'
          target: ${{ secrets.SERVER_DEPLOY_PATH }}
          overwrite: true
          strip_components: 2

      - name: Setup database and restart server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd ${{ secrets.SERVER_DEPLOY_PATH }}

            # 데이터베이스 파일이 없으면 빈 파일 생성 (첫 배포 시)
            # 이미 있으면 기존 데이터 보존
            if [ ! -f database.sqlite ]; then
              echo "Creating new database.sqlite file..."
              touch database.sqlite
            else
              echo "database.sqlite already exists, preserving existing data"
            fi

            # node_modules 설치 (production 모드)
            pnpm install --frozen-lockfile

            # PM2로 서버 재시작
            pm2 restart ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production

            # 또는 systemd 사용 시:
            # sudo systemctl restart kjcommerce-wms
