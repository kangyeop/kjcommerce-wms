service: wing-ad-reporter

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-2
  memorySize: 1024
  timeout: 300
  environment:
    CHROME_PATH: /opt/chrome/chrome
    DOWNLOAD_PATH: /tmp/wing-downloads
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
          Resource: "arn:aws:s3:::${self:custom.reportBucket}/*"

custom:
  reportBucket: ${opt:stage, 'dev'}-kjcommerce-wing-reports

functions:
  reporter:
    handler: dist/handler.handler
    events:
      - http:
          path: report
          method: post
          cors: true
    layers:
      - { Ref: ChromeAwsLambdaLayer }
    environment:
      NODE_OPTIONS: --max-old-space-size=1024

layers:
  chrome:
    name: chrome-aws-lambda
    description: Chrome binary for Playwright
    compatibleRuntimes:
      - nodejs20.x
    package:
      artifact: layers/chrome-aws-lambda.zip

package:
  patterns:
    - '!node_modules/playwright/**'
    - 'node_modules/playwright-core/**'
    - 'node_modules/exceljs/**'
    - '!node_modules/**/*.ts'
    - '!src/**'
    - 'dist/**'
    - '!tests/**'
    - '!.vscode/**'
    - '!*.log'

plugins:
  - serverless-dotenv-plugin